{% extends "admin/admin_base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<style>
  /* Professional, enhanced styling for the guide */
  .stats-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 8px 32px rgba(102, 126, 234, 0.2);
    transition: all 0.3s ease;
  }
  
  .stats-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 40px rgba(102, 126, 234, 0.3);
  }
  
  .stats-card.green {
    background: linear-gradient(135deg, #198754 0%, #20c997 100%);
    box-shadow: 0 8px 32px rgba(25, 135, 84, 0.2);
  }
  
  .stats-card.green:hover {
    box-shadow: 0 12px 40px rgba(25, 135, 84, 0.3);
  }
  
  .stats-card.orange {
    background: linear-gradient(135deg, #fd7e14 0%, #ffc107 100%);
    box-shadow: 0 8px 32px rgba(253, 126, 20, 0.2);
  }
  
  .stats-card.orange:hover {
    box-shadow: 0 12px 40px rgba(253, 126, 20, 0.3);
  }
  
  .stats-number {
    font-size: 2.5rem;
    font-weight: 800;
    margin: 0;
  }
  
  .stats-label {
    font-size: 0.95rem;
    opacity: 0.9;
    font-weight: 500;
    margin-bottom: 8px;
  }
  
  .stats-icon {
    font-size: 2.5rem;
    opacity: 0.8;
  }
  
  .quick-actions-card {
    background: linear-gradient(135deg, #f8faff 0%, #ffffff 100%);
    border: 2px solid #e2e8f0;
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
  }
  
  .action-btn {
    border-radius: 12px;
    padding: 14px 28px;
    font-weight: 600;
    font-size: 14px;
    margin: 6px;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }
  
  .action-btn::before {
    content: '';
    position: absolute;
    top: 50%; left: 50%;
    width: 0; height: 0;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    transition: all 0.4s ease;
    transform: translate(-50%, -50%);
  }
  
  .action-btn:hover::before {
    width: 300px;
    height: 300px;
  }
  
  .guide-card {
    background: linear-gradient(135deg, #ffffff 0%, #f8faff 100%);
    border: 2px solid #e2e8f0;
    border-radius: 20px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
    overflow: hidden;
  }
  
  .guide-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 24px 28px;
    margin: -1px -1px 0 -1px;
    border-radius: 20px 20px 0 0;
  }
  
  .guide-body {
    padding: 28px;
  }
  
  .step-badge{
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: #fff;
    font-weight: 700;
    font-size: 16px;
    margin-right: 12px;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
  }
  
  .step {
    border-left: 3px solid #e2e8f0;
    padding-left: 24px;
    margin-left: 18px;
    position: relative;
  }
  
  .step + .step {
    margin-top: 24px;
  }
  
  .step h6 {
    margin: 0;
    font-weight: 700;
    color: #2d3748;
    font-size: 16px;
  }
  
  .step-content {
    color: #4a5568;
    font-weight: 500;
    line-height: 1.6;
    margin-top: 8px;
  }
  
  .kbd {
    padding: 4px 8px;
    border: 2px solid #cbd5e0;
    border-bottom-width: 3px;
    border-radius: 6px;
    font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
    background: linear-gradient(135deg, #f8faff 0%, #f1f5f9 100%);
    color: #667eea;
    font-weight: 600;
    font-size: 13px;
  }
  
  .mono {
    font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
    background: linear-gradient(135deg, #f8faff 0%, #f1f5f9 100%);
    color: #667eea;
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: 600;
  }
  
  .tip {
    border-left: 4px solid #198754;
    background: linear-gradient(135deg, #f0fff4 0%, #dcfce7 100%);
    padding: 16px 20px;
    border-radius: 8px;
    margin: 12px 0;
  }
  
  .warn {
    border-left: 4px solid #dc3545;
    background: linear-gradient(135deg, #fff5f5 0%, #fef2f2 100%);
    padding: 16px 20px;
    border-radius: 8px;
    margin: 12px 0;
  }
  
  .page-title {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-weight: 800;
    font-size: 2.5rem;
    margin-bottom: 32px;
  }
  
  .toggle-btn {
    background: rgba(255, 255, 255, 0.2);
    border: 2px solid rgba(255, 255, 255, 0.3);
    color: white;
    border-radius: 8px;
    padding: 8px 16px;
    font-weight: 600;
    transition: all 0.3s ease;
  }
  
  .toggle-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    border-color: rgba(255, 255, 255, 0.5);
    color: white;
  } 
</style>

<div class="d-flex justify-content-between align-items-center mb-5">
  <h1 class="page-title mb-0">
    <i class="fas fa-tachometer-alt me-3"></i>Admin Dashboard
  </h1>
</div>

<!-- Enhanced Stats -->
<div class="row g-4 mb-5">
  <div class="col-md-4">
    <div class="stats-card">
      <div class="d-flex align-items-center justify-content-between">
        <div>
          <div class="stats-label">Total Exams</div>
          <div class="stats-number">{{ stats.total_exams }}</div>
        </div>
        <i class="fas fa-file-alt stats-icon"></i>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="stats-card green">
      <div class="d-flex align-items-center justify-content-between">
        <div>
          <div class="stats-label">Total Users</div>
          <div class="stats-number">{{ stats.total_users }}</div>
        </div>
        <i class="fas fa-users stats-icon"></i>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="stats-card orange">
      <div class="d-flex align-items-center justify-content-between">
        <div>
          <div class="stats-label">Admins</div>
          <div class="stats-number">{{ stats.total_admins }}</div>
        </div>
        <i class="fas fa-user-shield stats-icon"></i>
      </div>
    </div>
  </div>
</div>

<!-- Enhanced Quick actions -->
<div class="quick-actions-card mb-5">
  <h4 class="mb-4" style="color: #2d3748; font-weight: 700;">
    <i class="fas fa-bolt me-2" style="color: #667eea;"></i>Quick Actions
  </h4>
  <div class="d-flex flex-wrap gap-2">
    <a class="btn btn-primary action-btn" href="{{ url_for('admin.exams') }}">
      <i class="fas fa-file-alt me-2"></i> Manage Exams
    </a>
    <a class="btn btn-primary action-btn" href="{{ url_for('admin.questions_index') }}">
      <i class="fas fa-question-circle me-2"></i> Manage Questions
    </a>
    <a class="btn btn-primary action-btn" href="{{ url_for('admin.subjects') }}">
      <i class="fas fa-book me-2"></i> Manage Subjects
    </a>
    <a class="btn btn-outline-primary action-btn" href="{{ url_for('admin.upload_images_page') }}">
      <i class="fas fa-images me-2"></i> Upload Images
    </a> 
    <button id="open-latex-editor" class="btn btn-outline-primary action-btn" aria-label="Open LaTeX editor">
      <span class="latex-icon me-2" aria-hidden="true">∫</span>
      Open LaTeX Editor
    </button>    
    <a class="btn btn-success action-btn" href="{{ url_for('admin.publish') }}">
      <i class="fas fa-rocket me-2"></i> Publish
    </a>
  </div>
</div>

<!-- Enhanced Admin Guide -->
<div class="guide-card">
  <div class="guide-header">
    <div class="d-flex justify-content-between align-items-center">
      <h4 class="mb-0">
        <i class="fas fa-compass me-3"></i>Admin Guide — Running an Exam
      </h4>
      <button class="toggle-btn" type="button" data-bs-toggle="collapse" data-bs-target="#guideBody">
        <i class="fas fa-chevron-down me-1"></i> Toggle
      </button>
    </div>
  </div>
  
  <div id="guideBody" class="collapse show">
    <div class="guide-body">
      <div class="step">
        <div class="d-flex align-items-center mb-3">
          <span class="step-badge">1</span>
          <h6>Create the Exam</h6>
        </div>
        <div class="step-content">
          Go to <span class="kbd">Exams</span> → <span class="kbd">Create</span>. Fill <span class="mono">Name</span>, <span class="mono">Date</span>, <span class="mono">Start Time</span>, <span class="mono">Duration</span>, 
          <span class="mono">Total Questions</span>, <span class="mono">Instructions</span>, and marking (<span class="mono">Positive</span>/<span class="mono">Negative</span>).
        </div>
      </div>

      <div class="step">
        <div class="d-flex align-items-center mb-3">
          <span class="step-badge">2</span>
          <h6>Add Questions</h6>
        </div>
        <div class="step-content">
          Go to <span class="kbd">Questions</span>. Select an exam from the dropdown.
          <ul class="mb-3 mt-2">
            <li><strong>Single Add:</strong> Use <span class="kbd">Add Question</span> to add one at a time.</li>
            <li><strong>Batch Add:</strong> Use the "Batch Add Questions" panel. 
              Click <span class="kbd">Add Row</span> to create lines, fill details, then <span class="kbd">Add All</span> to append everything to <span class="mono">questions.csv</span> in a single save.
            </li>
          </ul>
          Supported types: <span class="mono">MCQ</span>, <span class="mono">MSQ</span>, <span class="mono">NUMERIC</span>.
        </div>
      </div>

      <div class="step">
        <div class="d-flex align-items-center mb-3">
          <span class="step-badge">3</span>
          <h6>Upload Images (optional)</h6>
        </div>
        <div class="step-content">
          Go to <span class="kbd">Upload Images</span>. Choose an existing subject folder or create one under <span class="kbd">Subjects</span> first.
          In your question, set <span class="mono">image_path</span> like:
          <div class="mt-2 mb-2">
            <code class="mono">Physics/ph-1.png</code> or <code class="mono">math/dt-1.png</code>
          </div>
          <div class="tip">
            <strong><i class="fas fa-lightbulb me-1"></i> Tip:</strong> The path format is <span class="mono">&lt;SubjectName&gt;/&lt;fileNameWithExtension&gt;</span>.  
            Ensure the image actually exists in that subject's Drive folder.
          </div>
        </div>
      </div>

      <div class="step">
        <div class="d-flex align-items-center mb-3">
          <span class="step-badge">4</span>
          <h6>Review & Edit</h6>
        </div>
        <div class="step-content">
          In <span class="kbd">Questions</span>, use the list to edit or delete any row. You can filter by exam using the dropdown and <span class="kbd">Load</span>.
        </div>
      </div>


<div class="step">
        <div class="d-flex align-items-center mb-3">
          <span class="step-badge">5</span>
          <h6>Configure Exam Attempts (Optional)</h6>
        </div>
        <div class="step-content">
          Go to <span class="kbd">Manage Attempts</span> to set how many times each user can take an exam:
          <ul class="mb-3 mt-2">
            <li><strong>Max Attempts:</strong> Set when creating exam in <span class="mono">max_attempts</span> field</li>
            <li><strong>Individual Control:</strong> Reset specific user attempts with <span class="kbd">Reset</span></li>
            <li><strong>Adjust Attempts:</strong> Use <span class="kbd">+1</span> to add attempts or <span class="kbd">Amount</span> field for bulk changes</li>
            <li><strong>Advanced Filters:</strong> Filter by user, exam, or status to manage attempts efficiently</li>
          </ul>
          <div class="tip">
            <strong><i class="fas fa-lightbulb me-1"></i> Tip:</strong> You can set unlimited attempts by leaving <span class="mono">max_attempts</span> empty or setting to 0.
          </div>
        </div>
      </div>

      <div class="step">
        <div class="d-flex align-items-center mb-3">
          <span class="step-badge">6</span>
          <h6>LaTeX Editor for Advanced Questions</h6>
        </div>
        <div class="step-content">
          Use <span class="kbd">Open LaTeX Editor</span> for creating complex mathematical equations and scientific content:
          <ul class="mb-3 mt-2">
            <li><strong>Mathematical Equations:</strong> Create complex formulas using LaTeX syntax</li>
            <li><strong>Chemical Reactions:</strong> Use mhchem for chemistry equations</li>
            <li><strong>Scientific Symbols:</strong> Access higher education symbols and notations</li>
            <li><strong>Live Preview:</strong> See rendered output in real-time</li>
            <li><strong>Direct Insert:</strong> LaTeX code automatically inserts into question text area</li>
            <li><strong>Save & Load:</strong> Save frequently used LaTeX templates for reuse</li>
          </ul>
          <div class="tip">
            <strong><i class="fas fa-lightbulb me-1"></i> Tip:</strong> The LaTeX editor opens in a popup window for side-by-side editing with your questions.
          </div>
        </div>
      </div>

      <div class="step">
        <div class="d-flex align-items-center mb-3">
          <span class="step-badge">7</span>
          <h6>User Management & Requests</h6>
        </div>
        <div class="step-content">
          Go to <span class="kbd">Users & Requests</span> to manage user access and permissions:
          <ul class="mb-3 mt-2">
            <li><strong>New Requests:</strong> Approve/deny user access requests with <span class="kbd">✔</span> / <span class="kbd">✖</span></li>
            <li><strong>Requests History:</strong> View all processed requests and their status</li>
            <li><strong>User Management:</strong> Update user roles individually or in bulk</li>
            <li><strong>Bulk Actions:</strong> Select multiple users and change roles simultaneously</li>
            <li><strong>Role Options:</strong> Assign user, admin, or both roles as needed</li>
          </ul>
          <div class="warn mt-3">
            <strong><i class="fas fa-exclamation-triangle me-1"></i> Important:</strong> When denying requests, you must provide a reason for the decision.
          </div>
        </div>
      </div>

      <div class="step">
        <div class="d-flex align-items-center mb-3">
          <span class="step-badge">8</span>
          <h6>Users Analytics & Tracking</h6>
        </div>
        <div class="step-content">
          Access <span class="kbd">Users Analytics</span> for comprehensive performance tracking:
          
          <h6 class="mt-3 mb-2" style="color: #2d3748; font-weight: 600;">Results & Responses Tab:</h6>
          <ul class="mb-3">
            <li><strong>View Results:</strong> See exam scores, percentages, grades, and duration</li>
            <li><strong>Detailed Responses:</strong> Check individual answers vs. correct answers</li>
            <li><strong>Export Options:</strong> Download/print results and responses as PDF</li>
            <li><strong>Advanced Filters:</strong> Filter by users, exams, date ranges</li>
          </ul>

          <h6 class="mb-2" style="color: #2d3748; font-weight: 600;">Analytics Tab:</h6>
          <ul class="mb-3">
            <li><strong>Visual Graphs:</strong> Score distribution and performance trends</li>
            <li><strong>Exam Performance:</strong> Compare results across different exams</li>
            <li><strong>User Activity:</strong> Track user engagement and participation</li>
            <li><strong>Top Performers:</strong> Identify highest-scoring students</li>
            <li><strong>Exam Statistics:</strong> Overall exam metrics and insights</li>
            <li><strong>Recent Activity:</strong> Latest user actions and submissions</li>
          </ul>
          <div class="tip">
            <strong><i class="fas fa-lightbulb me-1"></i> Tip:</strong> Use analytics to identify trends and improve exam quality over time.
          </div>
        </div>
      </div>

      <div class="step">
        <div class="d-flex align-items-center mb-3">
          <span class="step-badge">9</span>
          <h6>Publish & Go Live</h6>
        </div>
        <div class="step-content">
          When you're done with all changes, open <span class="kbd">Publish</span> and press <span class="kbd">Publish</span>.  
          This clears caches so students see the latest data.
          <div class="warn mt-3">
            <strong><i class="fas fa-exclamation-triangle me-1"></i> Important:</strong> Always publish after making changes to exams, questions, or user permissions.
          </div>
        </div>
      </div>      
    </div>
  </div>
</div>

<script>
(function(){
  const btn = document.getElementById('open-latex-editor');
  if(!btn) return;

  btn.addEventListener('click', () => {
    // open side-by-side popup; adjust size if needed
    const w = Math.max(Math.round(window.innerWidth * 0.6), 900);
    const h = Math.max(Math.round(window.innerHeight * 0.75), 600);
    const left = Math.round(window.screenX + (window.innerWidth - w) / 2);
    const top = Math.round(window.screenY + (window.innerHeight - h) / 2);
    window.open('/admin/latex_editor', 'latexEditor', `width=${w},height=${h},left=${left},top=${top},resizable=yes`);
  });

  // receive message from popup
  window.addEventListener('message', function(ev){
    try {
      // IMPORTANT: check origin if your site uses different host. Here we accept same-origin only
      if (ev.origin !== window.location.origin) return;
      const data = ev.data || {};
      if (data.type === 'latex-selected' && typeof data.latex === 'string') {
        const latex = data.latex;

        // Try best-effort to find the textarea/input to insert into:
        const target = document.querySelector('textarea[name="latex_content"], textarea#latex_editor, textarea[name="question_text"], textarea#question_text, textarea');
        if (target) {
          // insert at cursor if focused; else append at end
          try {
            const s = target.selectionStart || target.value.length;
            const e = target.selectionEnd || s;
            target.value = target.value.slice(0,s) + latex + target.value.slice(e);
            target.focus();
            // move caret after inserted text
            const pos = s + latex.length;
            target.selectionStart = target.selectionEnd = pos;
          } catch(err) {
            // fallback: append
            target.value = target.value + '\n' + latex;
          }
          // trigger input event so any listeners update preview/hidden fields
          target.dispatchEvent(new Event('input', { bubbles: true }));
        } else {
          // fallback: try focused element
          const active = document.activeElement;
          if (active && (active.tagName === 'TEXTAREA' || (active.tagName==='INPUT' && active.type==='text'))) {
            const s = active.selectionStart || active.value.length;
            const e = active.selectionEnd || s;
            active.value = active.value.slice(0,s)+latex+active.value.slice(e);
            active.selectionStart = active.selectionEnd = s + latex.length;
            active.dispatchEvent(new Event('input', { bubbles: true }));
          } else {
            alert('LaTeX received. No textarea found to paste into — paste manually:\n\n' + latex);
          }
        }
      }
    } catch(e) {
      console.error('latex message handler error', e);
    }
  }, false);
})();
</script>
{% endblock %}