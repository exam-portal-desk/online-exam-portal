{% extends "base.html" %}

{% block title %}Exam Response Analysis - ExamPortal{% endblock %}

{% block content %}
<style>
:root{
  --bg-1: #0f1724;
  --bg-2: #141428;
  --accent-a: #667eea;
  --accent-b: #764ba2;
  --success: #10b981;
  --muted: #cbd5e1;
  --glass: rgba(255,255,255,0.03);
  --card-radius: 14px;
  --strong-shadow: 0 30px 60px rgba(2,6,23,0.6);
  --btn-glow-color: rgba(102,126,234,0.28);
  --white: #ffffff;
  --muted-light: #cfe3ff;
  --gold-1: #ffd166;
  --gold-2: #ffb703;
  --green-1: #06b285;
  --teal-1: #2dd4bf;
}

.container.mt-4 { position: relative; z-index: 10; }

.card {
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.04);
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  color: var(--white);
  box-shadow: var(--strong-shadow);
}

.header-card {
  background: linear-gradient(90deg,var(--accent-a),var(--accent-b));
  color: #fff;
  border: none;
  padding: 1rem;
  border-radius: 10px;
  box-shadow: 0 18px 40px rgba(2,6,23,0.35);
}

.header-card h3 { margin: 0; font-weight: 800; letter-spacing: .2px; }
.score-summary h4 { margin: 0; font-weight: 900; color: #fff; }
.score-summary p { margin: 0; color: rgba(255,255,255,0.9); font-weight:600; }

.btn {
  border-radius: 10px;
  font-weight:800;
  letter-spacing: .2px;
  transition: transform .15s ease, box-shadow .18s ease;
  position: relative;
  color: #fff !important;
}
.btn:focus { box-shadow: 0 0 0 6px rgba(102,126,234,0.08); outline: none; }

.btn-primary-custom {
  background: linear-gradient(135deg, var(--accent-a), var(--accent-b));
  border: none;
  box-shadow: 0 10px 30px rgba(102,126,234,0.12);
}
.btn-success-custom {
  background: linear-gradient(135deg, var(--success), #059669);
  border: none;
  box-shadow: 0 10px 30px rgba(6,178,133,0.12);
}
.btn-danger-custom {
  background: linear-gradient(135deg, #ef4444, #f43f5e);
  border: none;
  box-shadow: 0 10px 30px rgba(239,68,68,0.12);
}

.btn-primary-custom:hover,
.btn-success-custom:hover,
.btn-danger-custom:hover {
  transform: translateY(-4px);
  box-shadow: 0 32px 80px var(--btn-glow-color);
}

.btn::before {
  content: '';
  position: absolute;
  top: -30%; left: -120%;
  width: 60%; height: 160%;
  background: linear-gradient(120deg, rgba(255,255,255,0.06), rgba(255,255,255,0));
  transform: rotate(25deg);
  transition: left .6s ease;
  pointer-events: none;
}
.btn:hover::before { left: 120%; }

.question-response-card { border-radius: 12px; overflow: hidden; }
.question-response-card .card-header {
  background: linear-gradient(90deg, rgba(0,0,0,0.18), rgba(255,255,255,0.02));
  color: #fff;
  font-weight:700;
}
.question-response-card .card-body { background: rgba(255,255,255,0.02); color: var(--white); }

.option-display {
  padding: .6rem;
  border-radius: 10px;
  margin-bottom: .6rem;
  font-weight: 700;
}
.bg-light { background: rgba(255,255,255,0.06) !important; color: #fff !important; }
.bg-success { background: linear-gradient(135deg,#06b285,#059669) !important; color: #fff !important; }
.bg-danger { background: linear-gradient(135deg,#ef4444,#dc2626) !important; color: #fff !important; }
.bg-warning { background: linear-gradient(135deg,#f59e0b,#f97316) !important; color: #111 !important; }
.bg-secondary { background: rgba(255,255,255,0.03) !important; color: rgba(255,255,255,0.9) !important; }

.badge-custom {
  background: rgba(255,255,255,0.06);
  color: #fff;
  font-weight:700;
  border-radius: 8px;
  padding: .25rem .45rem;
}

.stats-header {
  background: linear-gradient(90deg, #6366f1, #8b5cf6);
  color: #fff;
  font-weight: 700;
  padding: 0.8rem 1rem;
  border-radius: 8px;
}
.stats-card { background: rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.03); border-radius:12px; padding:1rem; box-shadow: 0 8px 22px rgba(0,0,0,0.3); }

.stat-inner { padding: 1rem; border-radius: 10px; background: rgba(255,255,255,0.03); box-shadow: 0 6px 18px rgba(0,0,0,0.3); }
.stat-value { font-size: 1.45rem; font-weight: 800; color: #fff; }
.stat-label { color: #cbd5e1; font-weight:700; }

.metric-glow {
  background: linear-gradient(90deg,var(--gold-1),var(--gold-2));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  font-weight: 900;
  font-size: 1.9rem;
  text-shadow: 0 6px 18px rgba(255, 190, 0, 0.14), 0 0 28px rgba(255,160,0,0.08);
  animation: metricPulse 2s infinite alternate;
}
@keyframes metricPulse {
  from { text-shadow: 0 6px 18px rgba(255, 190, 0, 0.12); transform: translateY(0); }
  to { text-shadow: 0 14px 34px rgba(255, 210, 80, 0.28); transform: translateY(-4px); }
}
.glow-star {
  background: linear-gradient(90deg,var(--gold-2),#ff9f1c);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  text-shadow: 0 8px 24px rgba(255,200,0,0.2);
  animation: starPulse 2s infinite alternate;
  font-size: 1.6rem;
}
@keyframes starPulse {
  from { text-shadow: 0 6px 12px rgba(255,200,0,0.14); transform: scale(1); }
  to { text-shadow: 0 14px 36px rgba(255,220,80,0.36); transform: scale(1.06); }
}

.label-glow-gold {
  color: var(--white);
  display: inline-block;
  padding: .15rem .45rem;
  border-radius: 8px;
  background: linear-gradient(90deg, rgba(255,215,0,0.08), rgba(255,215,0,0.02));
  box-shadow: 0 8px 30px rgba(255, 200, 0, 0.08), inset 0 -1px 0 rgba(255,255,255,0.02);
  font-weight:800;
}
.label-glow-green {
  color: var(--white);
  display: inline-block;
  padding: .15rem .45rem;
  border-radius: 8px;
  background: linear-gradient(90deg, rgba(6,178,133,0.08), rgba(6,178,133,0.02));
  box-shadow: 0 8px 30px rgba(6,178,133,0.08), inset 0 -1px 0 rgba(255,255,255,0.02);
  font-weight:800;
}
.label-glow-teal {
  color: var(--white);
  display: inline-block;
  padding: .15rem .45rem;
  border-radius: 8px;
  background: linear-gradient(90deg, rgba(45,212,191,0.08), rgba(45,212,191,0.02));
  box-shadow: 0 8px 30px rgba(45,212,191,0.08), inset 0 -1px 0 rgba(255,255,255,0.02);
  font-weight:800;
}

.text-muted-light { color: var(--muted-light) !important; font-weight:600; }

@media (max-width: 767px) {
  .score-summary { margin-top: .8rem; text-align: center; }
}

@media print {
  .navbar, .btn, #responseLoadingAlert { display: none !important; }
  body { background: white !important; color: #000 !important; }
}
</style>

<div class="container mt-4" id="responseContainer">
  <div class="card">
    <div class="card-body">

      {% if from_history %}
      <div class="row mb-3">
        <div class="col text-center">
          <a href="{{ url_for('dashboard') }}" class="btn btn-sm btn-primary-custom" style="border:1px solid rgba(255,255,255,0.06);">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
          </a>
        </div>
      </div>
      {% endif %}

      <div class="row mb-4" id="examHeader">
        <div class="col-md-12">
          <div class="header-card">
            <div class="row align-items-center">
              <div class="col-md-8">
                <h3><i class="fas fa-clipboard-check" style="color:var(--gold-2)"></i> {{ exam.name }} - Response Analysis</h3>
                <p class="mb-1 text-muted-light">Student: {{ session.full_name }}</p>
                <p class="mb-0 text-muted-light">Completed: {{ result.completed_at }}</p>
              </div>
              <div class="col-md-4 text-md-end score-summary">
                <div class="metric-glow">{{ result.score }} / {{ result.max_score }}</div>
                <p class="mb-0 text-muted-light">{{ result.percentage }}% &nbsp; | &nbsp; <span class="glow-star"><i class="fas fa-star"></i></span> &nbsp;<strong style="color:#fff;">{{ result.grade }}</strong></p>
              </div>
            </div>
          </div>
        </div>
      </div>

<div class="row mb-4">
  <div class="col-md-12 text-center">
    <button id="downloadPdfBtn" class="btn btn-success-custom btn-lg me-3">
      <i class="fas fa-file-pdf"></i> Download PDF
    </button>
    <a href="{{ url_for('response_txt', exam_id=exam.id) }}" 
       class="btn btn-outline-success btn-lg me-3" target="_blank">
      <i class="fas fa-file-text"></i> Download as Text
    </a>
    <button onclick="window.print()" class="btn btn-primary-custom btn-lg me-3">
      <i class="fas fa-print"></i> Print Response
    </button>
    <button onclick="closeResponseWindow()" class="btn btn-danger-custom btn-lg">
      <i class="fas fa-times"></i> Close
    </button>
  </div>
</div>

      <div id="responseContent">
        {% if responses %}
          {% for response in responses %}
          <div class="card mb-4 question-response-card">
            <div class="card-header
              {% if not response.is_attempted %}bg-secondary
              {% elif response.is_correct %}bg-success
              {% else %}bg-danger{% endif %}">
              <div class="row align-items-center">
                <div class="col-md-8">
                  <h6 class="mb-0">
                    <i class="fas fa-question-circle"></i> Question {{ loop.index }}
                    <span class="badge badge-custom ms-2">
                      {% if response.question_type == 'MCQ' %}Single Choice
                      {% elif response.question_type == 'MSQ' %}Multiple Choice
                      {% elif response.question_type == 'NUMERIC' %}Numerical
                      {% else %}{{ response.question_type }}{% endif %}
                    </span>
                  </h6>
                </div>
                <div class="col-md-4 text-end">
                  <span class="badge badge-custom fs-6">
                    {% if not response.is_attempted %}
                      <i class="fas fa-minus"></i> Not Attempted (0)
                    {% elif response.is_correct %}
                      <i class="fas fa-check"></i> Correct (+{{ response.marks_obtained }})
                    {% else %}
                      <i class="fas fa-times"></i> Incorrect ({{ response.marks_obtained }})
                    {% endif %}
                  </span>
                </div>
              </div>
            </div>

            <div class="card-body">
              <h6><strong>Question:</strong></h6>
              <p>{{ response.question.question_text | safe }}</p>

              {% if response.question.has_image and response.question.image_url %}
              <div class="mb-3 text-center">
                <img src="{{ response.question.image_url }}" alt="Question {{ loop.index }} Image"
                     class="img-fluid rounded shadow" style="max-width: 420px; cursor: pointer;"
                     onclick="openImageModal(this.src, 'Question {{ loop.index }} Image')"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                <div class="alert alert-warning mt-2" style="display:none;"><i class="fas fa-exclamation-triangle"></i> Image failed to load</div>
                <br>
                <small class="text-muted-light">Click to enlarge</small>
              </div>
              {% endif %}

              {% if response.question_type == 'MCQ' %}
                {% set options = [
                  {'id': 'A', 'text': response.question.option_a},
                  {'id': 'B', 'text': response.question.option_b},
                  {'id': 'C', 'text': response.question.option_c},
                  {'id': 'D', 'text': response.question.option_d}
                ] %}
                <div class="row">
                  <div class="col-md-6">
                    <h6><strong>Options:</strong></h6>
                    {% for opt in options %}
                      {% if opt.text and opt.text != 'nan' and opt.text|string|trim != '' and opt.text != 'None' %}
                        <div class="option-display
                          {% if response.is_attempted and opt.id == response.given_answer and opt.id == response.correct_answer %}bg-success
                          {% elif response.is_attempted and opt.id == response.given_answer and opt.id != response.correct_answer %}bg-danger
                          {% elif opt.id == response.correct_answer %}bg-success
                          {% else %}bg-light{% endif %}">
                          <strong>{{ opt.id }}.</strong> {{ opt.text | safe }}
                          {% if response.is_attempted and opt.id == response.given_answer %}
                            <i class="fas fa-arrow-left ms-2"></i> <span class="label-glow-gold">Your Choice</span>
                          {% endif %}
                          {% if opt.id == response.correct_answer %}
                            <i class="fas fa-check ms-2"></i> <span class="label-glow-green">Correct Answer</span>
                          {% endif %}
                        </div>
                      {% endif %}
                    {% endfor %}
                  </div>

                  <div class="col-md-6">
                    <strong><span class="label-glow-gold">Your Answer:</span></strong>
                    {% if response.is_attempted and response.given_answer %}
                      {{ response.given_answer }}
                    {% else %}
                      <span class="text-muted-light">Not Answered</span>
                    {% endif %}<br>
                    <strong><span class="label-glow-green">Correct Answer:</span></strong> {{ response.correct_answer or 'N/A' }}
                  </div>
                </div>

              {% elif response.question_type == 'MSQ' %}
                {% set options = [
                  {'id': 'A', 'text': response.question.option_a},
                  {'id': 'B', 'text': response.question.option_b},
                  {'id': 'C', 'text': response.question.option_c},
                  {'id': 'D', 'text': response.question.option_d}
                ] %}

                {% set given_list = [] %}
                {% set correct_list = [] %}
                {% if response.is_attempted and response.given_answer %}
                  {% if response.given_answer is string and response.given_answer != 'None' %}
                    {% set given_list = response.given_answer.split(',') if ',' in response.given_answer else [response.given_answer] %}
                  {% elif response.given_answer is iterable and response.given_answer is not string %}
                    {% set given_list = response.given_answer %}
                  {% endif %}
                {% endif %}
                {% if response.correct_answer %}
                  {% if response.correct_answer is string and response.correct_answer != 'None' %}
                    {% set correct_list = response.correct_answer.split(',') if ',' in response.correct_answer else [response.correct_answer] %}
                  {% elif response.correct_answer is iterable and response.correct_answer is not string %}
                    {% set correct_list = response.correct_answer %}
                  {% endif %}
                {% endif %}

                <div class="row">
                  <div class="col-md-6">
                    <h6><strong>Options:</strong></h6>
                    {% for opt in options %}
                      {% if opt.text and opt.text != 'nan' and opt.text|string|trim != '' and opt.text != 'None' %}
                        {% set in_given = response.is_attempted and opt.id in given_list %}
                        {% set in_correct = opt.id in correct_list %}
                        <div class="option-display
                          {% if in_given and in_correct %}bg-success
                          {% elif in_given and not in_correct %}bg-danger
                          {% elif not in_given and in_correct %}bg-warning
                          {% else %}bg-light{% endif %}">
                          <strong>{{ opt.id }}.</strong> {{ opt.text | safe }}
                          {% if in_given %} <i class="fas fa-check-square ms-2"></i> <span class="label-glow-gold">Your Choice</span>{% endif %}
                          {% if in_correct %} <i class="fas fa-star ms-2"></i> <span class="label-glow-green">Correct Option</span>{% endif %}
                        </div>
                      {% endif %}
                    {% endfor %}
                  </div>

                  <div class="col-md-6">
                    <strong><span class="label-glow-gold">Your Selection:</span></strong>
                    {% if response.is_attempted and given_list %}
                      {{ given_list|join(', ') }}
                    {% else %}
                      <span class="text-muted-light">Not Answered</span>
                    {% endif %}<br>
                    <strong><span class="label-glow-green">Correct Selection:</span></strong> {{ correct_list|join(', ') or 'N/A' }}
                  </div>
                </div>

              {% elif response.question_type == 'NUMERIC' %}
                <div class="row">
                  <div class="col-md-12">
                    <strong><span class="label-glow-gold">Your Answer:</span></strong>
                    {% if response.is_attempted and response.given_answer %}
                      {{ response.given_answer }}
                    {% else %}
                      <span class="text-muted-light">Not Answered</span>
                    {% endif %}<br>
                    <strong><span class="label-glow-green">Correct Answer:</span></strong> {{ response.correct_answer or 'N/A' }}
                    {% if response.question.tolerance %}
                      <br><strong><span class="label-glow-teal">Tolerance:</span></strong> Â±{{ response.question.tolerance }}
                    {% endif %}
                  </div>
                </div>

              {% else %}
                <div class="alert alert-warning">
                  <strong>Unknown question type:</strong> {{ response.question_type }}
                </div>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        {% else %}
          <div class="alert alert-warning text-center">
            <h4><i class="fas fa-exclamation-triangle"></i> No Response Data Found</h4>
            <p>No responses were found for this exam.</p>
          </div>
        {% endif %}
      </div>

      <div class="card mt-4">
        <div class="card-header stats-header text-center">
          <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Performance Summary</h5>
        </div>
        <div class="card-body stats-card">
          <div class="row text-center g-3">
            <div class="col-6 col-md-2">
              <div class="stat-inner">
                <div class="stat-value">{{ result.correct_answers if result.correct_answers is defined else (responses|selectattr('is_correct')|selectattr('is_attempted')|list|length) }}</div>
                <div class="stat-label">Correct</div>
              </div>
            </div>
            <div class="col-6 col-md-2">
              <div class="stat-inner">
                <div class="stat-value">{{ result.incorrect_answers if result.incorrect_answers is defined else (responses|rejectattr('is_correct')|selectattr('is_attempted')|list|length) }}</div>
                <div class="stat-label">Incorrect</div>
              </div>
            </div>
            <div class="col-6 col-md-2">
              <div class="stat-inner">
                <div class="stat-value">{{ result.unanswered_questions if result.unanswered_questions is defined else (responses|rejectattr('is_attempted')|list|length) }}</div>
                <div class="stat-label">Unanswered</div>
              </div>
            </div>
            <div class="col-6 col-md-2">
              <div class="stat-inner">
                <div class="stat-value metric-glow">{{ result.score }}</div>
                <div class="stat-label">Score</div>
              </div>
            </div>
            <div class="col-6 col-md-2">
              <div class="stat-inner">
                <div class="stat-value">{{ result.total_questions }}</div>
                <div class="stat-label">Total</div>
              </div>
            </div>
            <div class="col-6 col-md-2">
              <div class="stat-inner">
                <div class="stat-value">{{ result.percentage }}%</div>
                <div class="stat-label">Percentage</div>
              </div>
            </div>
          </div>

          <hr>

          <div class="row text-center mt-3">
            <div class="col-md-6">
              <strong>Attempted:</strong>
              {% set attempted_count = (result.correct_answers if result.correct_answers is defined else (responses|selectattr('is_correct')|selectattr('is_attempted')|list|length)) + (result.incorrect_answers if result.incorrect_answers is defined else (responses|rejectattr('is_correct')|selectattr('is_attempted')|list|length)) %}
              {{ attempted_count }} / {{ result.total_questions }}
            </div>
            <div class="col-md-6">
              <strong>Accuracy (on attempted):</strong>
              {% set correct_count = result.correct_answers if result.correct_answers is defined else (responses|selectattr('is_correct')|selectattr('is_attempted')|list|length) %}
              {% if attempted_count > 0 %}
                {{ (correct_count / attempted_count * 100) | round(1) }}%
              {% else %}
                N/A
              {% endif %}
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<div class="modal fade" id="responseImageModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="imageModalTitle"><i class="fas fa-image me-2"></i> Question Image</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center p-4">
        <img id="responseModalImage" src="" alt="Question image" class="img-fluid rounded shadow" style="max-height: 80vh;">
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
function openImageModal(src, title) {
    const modal = document.getElementById('responseImageModal');
    const img = document.getElementById('responseModalImage');
    const titleEl = document.getElementById('imageModalTitle');
    
    if (modal && img && titleEl) {
        img.src = src;
        titleEl.innerHTML = '<i class="fas fa-image me-2"></i>' + title;
        
        if (window.bootstrap) {
            new bootstrap.Modal(modal).show();
        }
    }
}

function closeResponseWindow() {
    if (window.opener) {
        window.close();
    } else {
        window.history.back();
    }
}

// Simple PDF download using backend route
document.getElementById('downloadPdfBtn').onclick = function() {
    const btn = this;
    const originalText = btn.innerHTML;
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating PDF...';
    
    // Use backend route for PDF generation
    window.open('{{ url_for("response_pdf", exam_id=exam.id) }}', '_blank');
    
    // Reset button after a delay
    setTimeout(() => {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }, 2000);
};
</script>
{% endblock %}
